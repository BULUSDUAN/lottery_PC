@using System.Text
@using app.lottery.site.cbbao.Models
@using app.lottery.site.jsonManager
@{
    var match = ViewBag.Matches as List<BJDC_MatchInfo_WEB>;
    //联赛信息
    var leagues = new List<string>();
    //截止比赛的matchid
    var endedMatchid = new List<int>();
    var iscurrent = ViewBag.IsCurrent;

    if (match != null && match.Count > 0)
    {
        const string headCols = "<col width=\"87\"/><col width=\"51\"/><col width=\"249\"/><col width=\"425\"/><col width=\"63\"/><col width=\"126\"/>";
        var endTime = match[0].MatchStartTime.Hour < 10 ? Convert.ToDateTime(match[0].MatchStartTime.ToString("yyyy-MM-dd")).AddHours(10) : Convert.ToDateTime(match[0].MatchStartTime.AddDays(1).ToString("yyyy-MM-dd")).AddHours(10);
        var title = endTime.AddDays(-1).ToString("yyyy年MM月dd日") + " " + SiteConvert.Week_CN(endTime.AddDays(-1).DayOfWeek);
        var thead = new StringBuilder();
        thead.Append("<table class=\"lot_con\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><colgroup>" + headCols + "</colgroup>");
        thead.Append("<thead><tr><th height=\"32\" colspan=\"7\">");
        thead.Append("<div title=\"" + title + "\" id=\"a_" + endTime.AddDays(-1).ToString("yyyyMMdd") + "\" class=\"tps hide_a\">");
        thead.Append("<span>" + title + "&nbsp;&nbsp;[10：00--次日10：00]</span><i class=\"line-01\"></i></div></th></tr></thead><tbody>");


        @(new HtmlString(thead.ToString()))

        var abbr = string.Empty;
        //var state = string.Empty;
        var matchid = 0;
        var flag = false;
        var result = string.Empty;
        var let = 0;
        var sale = 0;
        var mid = 0;
        foreach (var item in match)
        {
            flag = false;
            //sale=true开售false未开售
            sale = item.LocalStopTime > DateTime.Now && item.MatchStateName != "Cancel" && item.MatchStateName != "Late" ? 1 : 0;

            var startTime = Convert.ToDateTime(item.MatchStartTime);
            var stopTime = item.LocalStopTime;
            matchid = item.MatchOrderId;
            mid = item.Mid;
            let = item.LetBall;

            if (!leagues.Contains(item.MatchName))
            {
                leagues.Add(item.MatchName);
            }
            if (sale == 0)
            {
                endedMatchid.Add(matchid);
                result = item.BF_Result;
            }

            if (startTime >= endTime)
            {
                //上一个table结束
                @(new HtmlString("</tbody></table>"))
                endTime = endTime.AddDays(1);
                title = endTime.AddDays(-1).ToString("yyyy年MM月dd日") + " " + SiteConvert.Week_CN(endTime.AddDays(-1).DayOfWeek);

                //开始新的table    
                thead = new StringBuilder();
                thead.Append("<table class=\"lot_con\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><colgroup>" + headCols + "</colgroup>");
                thead.Append("<thead><tr sale=\"" + sale + "\"><th height=\"32\" colspan=\"7\">");
                thead.Append("<div title=\"" + title + "\" id=\"a_" + endTime.AddDays(-1).ToString("yyyyMMdd") + "\" class=\"tps hide_a\">");
                thead.Append("<span>" + title + "&nbsp;&nbsp;[10：00--次日10：00]</span><i class=\"line-01\"></i></div></th></tr></thead><tbody>");
                @(new HtmlString(thead.ToString()))
            }

            abbr = matchid + "|" + item.HomeTeamName + "|" + item.GuestTeamName + "|" + let + "|" + startTime.ToString("yyyy/MM/dd HH:mm:ss");
            <tr id="@matchid" abbr="@abbr" name="@endTime.AddDays(-1).ToString("yyyyMMdd")" league="@item.MatchName" sale="@sale" class="mtr@(sale == 1 || iscurrent ? "" : " hide_tr")">
                <td>
                    <span hover="xulie_h" onclick=" jcpage.dymanic_.ftdClick(@matchid, '周@(matchid)') " class="xulie">@matchid</span>
                    <a style="color: #FFFFFF; background-color: @(string.IsNullOrEmpty(item.MatchColor) ? "ff3d00" : item.MatchColor)" title="@item.MatchName" @SiteString.GetLeagueHref(item.MatchId) class="saiming aochao">@item.MatchName</a>
                </td>
                <td title="截止时间:@stopTime.ToString("yyyy-MM-dd HH:mm")">
                    @{
                        if (sale == 0)
                        {
                            if (!string.IsNullOrEmpty(item.HomeFull_Result) && !string.IsNullOrEmpty(item.GuestFull_Result))
                            {
                                flag = true;
                                <span class="red">@(item.HomeFull_Result + ":" + item.GuestFull_Result)</span>
                            }
                        }
                        <span class="b_time hide" title="开赛时间:@startTime.ToString("yyyy-MM-dd HH:mm")">@startTime.ToString("HH:mm")</span>
                        <span class="e_time@(flag ? " hide" : "")" title="截止时间:@stopTime.ToString("yyyy-MM-dd HH:mm")">@stopTime.ToString("HH:mm")</span>
                    }
                </td>
                <td class="team">
                    <a @(string.IsNullOrEmpty(item.HomeTeamId) ? "href=javascript:void(0)" : SiteString.GetTeamHref(Convert.ToInt32(item.HomeTeamId))) title="@item.HomeTeamName"><span>@item.HomeTeamName</span></a>
                    <em>vs</em>
                    <a class="guest" @(string.IsNullOrEmpty(item.GuestTeamId) ? "href=javascript:void(0)" : SiteString.GetTeamHref(Convert.ToInt32(item.GuestTeamId))) title="@item.GuestTeamName"><span>@item.GuestTeamName</span></a>
                </td>
                <td class="bf_kg">
                    <div class="scoretz_setbox betConObj">
                        <p></p>
                        <a href="javascript:void 0;" r="0" class="scorebtn" data-id="@matchid">
                            <strong>投注</strong>
                            <em class="icon2"></em>
                        </a>
                    </div>
                </td>
                <td class="datas fx_hh">
                    @ViewHelpers.yox(mid,5)
                </td>
                <td class="odds_data" id="odd_@(matchid)">
                    <div id="odd_@(matchid)_oz">
                        <span id="odd_@(matchid)_1" class="op">@item.WinOdds</span>
                        <span id="odd_@(matchid)_2" class="op">@item.FlatOdds</span>
                        <span id="odd_@(matchid)_3" class="op">@item.LoseOdds</span>
                    </div>
                </td>
            </tr>
            if (sale == 0)
            {
                <tr id="ht_@(matchid)" class="more_zk hide_tr" sale="@sale">
                    <td colspan="6">
                        <div class="ht_wrap">
                            <table class="bf_cell">
                                <tr class="zk_1">
                                    <td width="8%" height="40">主胜</td>
                                    @ViewHelpers.Bjdc_bf_view(matchid, "X0", "胜其它", sale, item.S_QT, 0, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "10", "1:0", sale, item.S_10, 0, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "20", "2:0", sale, item.S_20, 0, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "21", "2:1", sale, item.S_21, 0, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "30", "3:0", sale, item.S_30, 0, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "31", "3:1", sale, item.S_31, 0, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "32", "3:2", sale, item.S_32, 0, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "40", "4:0", sale, item.S_40, 0, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "41", "4:1", sale, item.S_41, 0, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "42", "4:2", sale, item.S_42, 0, result)
                                    <td class="bf_all"><a title="全" href="javascript:void(0)" class="all" rel="bf_a0_@(matchid)">&nbsp;</a></td>
                                </tr>
                                <tr class="zk_1">
                                    <td width="8%" height="40">平局</td>
                                    @ViewHelpers.Bjdc_bf_view(matchid, "XX", "平其他", sale, item.P_QT, 1, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "00", "0:0", sale, item.P_00, 1, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "11", "1:1", sale, item.P_11, 1, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "22", "2:2", sale, item.P_22, 1, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "33", "3:3", sale, item.P_33, 1, result)
                                    <td colspan="5"></td>
                                    <td class="bf_all"><a title="全" href="javascript:" class="all" rel="bf_a1_@(matchid)">&nbsp;</a></td>
                                </tr>
                                <tr class="zk_1">
                                    <td width="8%" height="40">客胜</td>
                                    @ViewHelpers.Bjdc_bf_view(matchid, "0X", "负其它", sale, item.F_QT, 2, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "01", "0:1", sale, item.F_01, 2, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "02", "0:2", sale, item.F_02, 2, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "12", "1:2", sale, item.F_12, 2, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "03", "0:3", sale, item.F_03, 2, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "13", "1:3", sale, item.F_13, 2, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "23", "2:3", sale, item.F_23, 2, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "04", "0:4", sale, item.F_04, 2, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "14", "1:4", sale, item.F_14, 2, result)
                                    @ViewHelpers.Bjdc_bf_view(matchid, "24", "2:4", sale, item.F_24, 2, result)
                                    <td class="bf_all"><a title="全" href="javascript:" class="all" rel="bf_a2_@(matchid)">&nbsp;</a></td>
                                </tr>
                            </table>
                        </div>
                    </td>
                </tr>
            }
        }
        @(new HtmlString("</tbody></table>"))
    }
    else
    {
        <div class="nords" id="nords"><strong>当前无开售赛事，请等待官方公布新赛程！</strong></div>
    }
}
<script type="text/javascript">
    var leaguesRelate=@(new HtmlString(Common.JSON.JsonHelper.Serialize(leagues)));
    var endMatch = @(new HtmlString(Common.JSON.JsonHelper.Serialize(endedMatchid)));
</script>

